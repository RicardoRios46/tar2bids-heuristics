#!/bin/bash

#query,retrieve,and tgz CFMM's dicom data from sharcnet.

# In order to run this script as a cron task:
#   1.save your uwo username and password to ~/.uwo_crendential:
#     <username>
#     <password>
#     chmod 600 ~/.uwo_credentials 
#   2.setup passwordless ssh login to graham.sharnet.ca 

#Author: YingLi Lu
#e-mail: yinglilu@gmail.com
#date: 2017-11-21

#for test:
#  StudyDate='20171108' #This study date has three patients, each has one study
#  StudyDate='20170529' #smaller data


function usage { 

  echo "Retrieves studies based on StudyDescription & Date.  If date not provided, all studies are downloaded"
  echo "Uses credentials in ~/.uwo_credentials or prompts for username/password" 
  echo ""
  echo "Usage: `basename $0` '<studydesc-search>' '<date-search>' <output folder>  <optional flags>"
  echo "	Example (all scans on specific date): `basename $0` 'Khan*' '20170530' myfolder"
  echo "	Example (all scans since date): `basename $0` 'Khan*' '20170530-' myfolder"
  echo "	Example (all scans in date range): `basename $0` 'Khan^NeuroAnalytics' '20170530-20170827' myfolder"
  echo "	Example (all scans in all dates): `basename $0` 'Khan*' '-' myfolder"

}


if [ "$#" -lt 3 ]
then
	usage
	exit 1
fi


STUDY_SEARCH=$1
DATE_SEARCH=$2
OUTPUT_DIR=$3

shift 3
#UWO credentials: need to login dicom.cfmm.robarts.ca
UWO_CREDNTIALS=~/.uwo_credentials

if [ ! -e $UWO_CREDNTIALS ]
then
read -p "UWO Username: " UWO_USERNAME
read -srp "UWO Password: " UWO_PASSWORD
else
UWO_USERNAME=$(sed -n '1 p' ${UWO_CREDNTIALS})
UWO_PASSWORD=$(sed -n '2 p' ${UWO_CREDNTIALS})
fi


CONFIG_DCM_RETRIEVE=$AUTOBIDS_DIR/cfg/dicom-retrieve.cfg
#load in CONFIG_DCM_RETRIEVE file
if [ -e $CONFIG_DCM_RETRIEVE  ]
then
	source $CONFIG_DCM_RETRIEVE
else
	echo "ERROR: $CONFIG_DCM_RETRIEVE not found!"
	exit 1
fi

if [ ! -e $DOWNLOADED_TAR_LIST ]
then
	touch ${DOWNLOADED_TAR_LIST}
fi

if [ ! -e $DOWNLOADED_UID_LIST ]
then
	touch ${DOWNLOADED_UID_LIST}
fi



DICOMS_DIR=$OUTPUT_DIR/dicoms
mkdir -p $OUTPUT_DIR $DICOMS_DIR

#singularity image defined in CONFIG_DCM_RETRIEVE file
((singularity run $SINGULARITY_OPTS $SINGULARITY_IMG \
${UWO_USERNAME} \
${UWO_PASSWORD} \
${CONNECT} \
${STUDY_SEARCH} \
${DICOMS_DIR} \
${KEEP_SORTED_DICOM} \
${OUTPUT_DIR} \
${DATE_SEARCH} \
${DOWNLOADED_UID_LIST}  3>&1 1>&2 2>&3 | grep -E -v "^Picked up _JAVA_OPTIONS:|^tar: Removing leading")  3>&1 2>&1  )
