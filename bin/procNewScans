#!/bin/bash

# Line below locks the script so cannot be run simultaneously (i.e. to prevent conflicts)
[ "${FLOCKER}" != "$0" ] && exec env FLOCKER="$0" flock -en "$0" "$0" "$@" || :

CONFIG_DCM_RETRIEVE=$AUTOBIDS_DIR/cfg/dicom-retrieve.cfg
#load in CONFIG_DCM_RETRIEVE file
if [ -e $CONFIG_DCM_RETRIEVE  ]
then
	source $CONFIG_DCM_RETRIEVE
else
	echo "ERROR: $CONFIG_DCM_RETRIEVE not found!"
	exit 1
fi



if [ "$#" -lt 1 ]
then
    dates=$(date +'%Y%m%d')
else
    dates=$@
fi

mkdir -p $RETRIEVE_LOG_DIR
LOG=$RETRIEVE_LOG_DIR/`date +%Y-%m-%d`.txt

for date in $dates
do

scratch_dir=/scratch/$USER/incoming_$RANDOM

#download tarballs for all studies
for study in `$AUTOBIDS_DIR/etc/getListStudies`
do
 
 echo Retrieving dicoms for ${study}* on ${date}... | tee -a $LOG
 getDicomTarballs \'${study}*\' \'${date}\' $scratch_dir | tee -a $LOG

done

#process each individually
count=`ls -1 $scratch_dir/*.tar 2> /dev/null  | wc -l `
if [ "$count" -gt 1 ]
then
for tar in `ls $scratch_dir/*.tar`
do
  tar_name=${tar##*/}
  if [ ! $(grep ${tar_name} $DOWNLOADED_TAR_LIST) ]
  then
	echo $tar_name >> $DOWNLOADED_TAR_LIST
	autobidsProcess $tar 
  fi

done
fi

done
